# SMTP
* User Agent
* Mail Server
* SMTP 로 구성

각 메일 서버는 다른 메일 서버로 메일을 전송하고, 수신받아 저장한다. 사용자가 요구하면 다운받아서 읽을 수 있도록 해줌

이런 메일 서버간 통신을 지원하는 프로토콜을 SMTP 라고 한다

Text-only 메시지 전송 프로토콜이다

* 릴레이
    * 외부 네트워크에서 해당 메일서버를 경유하여 외부로 메일을 보내는 것을 의미
    * 스팸으로 악용될 수 있다

## SMTP 프로토콜 동작 절차
* 연결 설정과 해제
    * TCP 연결
    * 전송 메일서버가 수신서버에게 송신 메일서버 도메인 알려줌
    * OK 회신
    * 메일전송
    * 연결해제요청
    * 연결해제 OK
* 송신메일서버 도메인을 알려줄 때
    * 송수신자 메일도 함께 보냄
    * 어느 메일박스로 수신자가 저장할 지 앎


## 이메일 전송 과정
1. 송신자가 메일 작성 후 메일 서버로 전달
    * SMTP 혹은 HTTP 사용
2. 송신자 메일 서버의 출력 메시지 큐에 저장
3. 수신가 메일 서버로 SMTP 프로토콜을 이용하여 전송, TCP 연결을 사용한다
4. 전송 불가시 30분 단위로 재전송 시도, 정해진 기간 동안 전송 불가시 중단 및 송신자에게 통보
5. 수신자 메일 서버의 수신자 메일박스에 저장
6. 수진자 UA에서 메일 서버의 메일박스의 메일 읽기 및 관리
    * mail access protocol 사용

## 수신 메일서버에서 수신 user
수신 user agent가 현재 작동하고 있다고 보장할 수 없다

그래서 mail access protocol을 사용

* POP3
* IMAP4
    * 메일서버에 폴더로 메시지 관리 기능
* HTTP
    * 현재 주로 사용

# aws ses란
Simple Email Service
 
* Outbound만 가능한 이메일 전송 서비스
 
* 마케팅이나 혹은 웹진 메일 같은 대량의 이메일을 발송하기에 적절함

* 사전 확약금 없이 발송한 이메일의 수와 데이터 전송에 대해 요금이 부과됨
저렴한 비용으로 이용할 수 있음

* 전송 작업의 상태를 쉽게 모니터링할 수 있음

* 입증된 네트워크 인프라와 데이터 센터에서 운영되므로 가용성과 안정성이 높음

* ISP(인터넷 서비스 제공업체)는 자체적으로 필터링 기능을 사용하여 많은 스팸 메일을 걸러 내기는 하지만 완벽한 필터링은 가능하지 않음

* 회원 이메일 주소 확인용 이메일 같은 메일의 경우도 스팸으로 분류하기도 하므로 이러한 부분도 신경을 써야 함

* ISP는 SES 서비스를 거친 이메일을 신뢰하게 되어 메일 도달 가능성을 높여줌

* 컨텐츠 필터링 기능을 사용하여 바이러스나 멀웨어를 포함한 메시지를 감지하여 발신 전에 차단함

* SPF(Sender Policy Framework) 및 DKIM(DomainKeys Identified Mail)과 같은 인증 메커니즘을 지원함

* 전송 시도, 거부 메시지, 반송, 수신 거부 등의 통계를 자동으로 수집 및 제공하여 모니터링할 수 있음

SES 사용 절차
도메인 혹은 이메일 주소 인증
프로덕션 액세스 요청 및 승인
이메일을 보내고 피드백을 받을 수 있음


## 작동 방식
![](https://docs.aws.amazon.com/ko_kr/ses/latest/dg/images/arch_overview-diagram.png)

## SPF(메일서버등록제)
이메일 발신자가 위조되지 않았는지 검증하는 방법

발신 메일서버 정보를 SPF 형식을 DNS에 등록

송신 IP를 송신 DNS에 질의, 송신 IP가 틀리면 스팸

* SPF 레코드
    * 메일 수신을 허용할 메일 서버를 도메인을 식별하는 DNS레코드의 일종

## DKIM(DomainKeys Identified Mail)
특정 도메인에서 전송했다고 주장하는 이메일이 해당 도메인의 소유자가 실제로 승인했는지 확인하기 위해 고안된 이메일 보안 표준

공개키 암호화 방식을 사용, 개인키로 이메일에 서명(RSA, Diffine-Helmman)을 적용하여 보내는 방식이다.

수신자 메일서버는 도메인의 DNS에 게시된 공개키를 이용해 발신자와 메일의 무결성을 검증한다

DKIM을 적용하면 배달 가능성이 올라가고 reject 가능성이 줄어듬

## 도입 이유
* 비용측면에서 좋다
* AWS SES를 거치면 더 신뢰성, 직접 보내면 스팸 취급당할 수 있다
* 통계
* DKIM, SPF 등 인증 메커니즘지원

* 직접 구현하게 되면 이런 것들을 직접 전부 구현해주어야 한다


## 구현
AmazonSimpleEmailServiceAsync을 사용하였다.

그냥 AmazonSimpleEmailService와 비교하면 비동기적으로 처리할 수 있기 때문에 좋다.




https://yhsim98.tistory.com/4
에 설정법과 spring boot 에서의 구현을 적어놓았다.