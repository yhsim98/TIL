http://www.yes24.com/Product/Goods/19040233

1. SQL 중심적인 개발의 문제점



# SQL 중심적인 개발의 문제점

## SQL에 의존적인 개발을 피하기 어렵다
중간에 domain 에 변경이 있으면 관계된 모든 sql을 일일히 수정해야 한다.

번거롭고 특정 sql을 실수로 수정하지 않는 등 실수의 여지가 많다

## 패러다임의 불일치
* 객체와 관계형 데이터베이스의 차이

1. 상속
2. 연관관계
3. 데이터 타입
4. 데이터 식별 방법

등에서 여러가지로 힘들어진다.

객체지향적으로 개발할수록 매핑이 힘들어지는 문제가 생긴다.
그래서 대안으로 나온 것 이 JPA

# JPA(Java-Persistent-Api)
JPA는 ORM 기술이다

ORM(Objective-relational mapping)
* 객체는 객체대로, 관계형 db는 관계형 db대로 설계
* ORM 프레임워크가 중간에서 매핑

JPA는 Java 애플리케이션과 JDBC 사이에서 동작한다. DB에서 JDBC 가 받으면 그것을 JPA가 매핑하고, 애플리케이션에서 JPA로 보내면 JPA가 JDBC에 매핑한다.

## JPA 장점
생산성
* CRUD 쿼리가 이미 존재한다

유지보수
* 기존 필드 변경시 SQL은 자동으로 JPA가 처리

패러다임 불일치 해결
* 상속 등 자동으로 처리해준다

신뢰할 수 있는 엔티티, 계층
* 동일한 트랜잭션에서 조회한 엔티티는 같음을 보장한다
    * user1 == user2 보장


## JPA의 성능 최적화 기능
1차 캐시와 동일성 보장
* 같은 트랜잭션 안에서는 같은 엔티티를 반환 - 약간의 조회 성능 향상 

2. 트랜잭션을 지원하는 쓰기 지연
* 트랜잭션을 커밋할 때까지 비슷한 SQL을 모은다
* JDBC BATCH SQL 기능을 사용해서 한번에 SQL 전송한다

3. 지연 로딩
    
지연 로딩
* 객체가 실제 사용될 때 로딩

즉시로딩 
* JOIN SQL 로 한번에 연관된 객체까지 미리 조회

## JPQL
JPA 가 제공하는 SQL 을 추상화한 객체 지향 쿼리 언어

SELECT, GROUP BY, HAVING, JOIN 등을 지원한다

엔티티 객체를 대상으로 쿼리

## 엔티티 매니저 팩토리와 엔티티 매니저
EntityManagerFactory 라는 클래스가 요청이 올 때마다 EntityManager을 생성, EntityManager 는 DB 커넥션을 사용하여 DB를 사용한다.

# 영속성 컨텍스트
엔티티를 영구 저장하는 환경이라는 뜻

EntitiyManager.persist(entity) 라고 하면 엔티티를 db가 아닌 영속성 컨택스트라는 곳에 저장한다.

## 엔티티의 생명주기
비영속
* 영속성 컨텍스트와 전혀 관계가 없는 새로운 상태
* 객체를 생성하기만 한 상태

영속
* 영속성 컨텍스트에 관리되는 상태 
* 엔티티메니저에 persist 해서 객체를 넣은 상태
* 바로 db에 날라가는 것이 아님

준영속
* 영속성 컨텍스트에 저장되었다가 분리된 상태 
* detach 

삭제
* 삭제된 상태


## 영속성 컨텍스트의 이점
* 1차 캐시
    * 바로 DB 에 가는 것이 아닌 캐시를 먼저 조회한다
    * 캐시에 없다면 DB 를 조회한 후 캐시에 저장한다
    * 트랜잭션 단위로 작동하고 트랜잭션이 끝나면 영속성 컨텍스트도 종료하기 때문에 사실 별로 도움이 안된다

* 동일성 보장
    * == 비교하면 같다

* 트랜잭션을 지원하는 쓰기 지연
    * insert 문을 모았다가 커밋 시점에 한번에 보낸다
    * batch 옵션이다

* 변경 감지(Dirty checking)
    * 엔티티메니저에 객체를 넣고 나면 객체를 변경하기만 해도 DB까지 자동으로 변경됨

* 지연 로딩


## 플러시
영속성 컨텍스트의 변경내용을 데이터베이스에 반영

플러시 발생
* 변경 감지
* 수정된 엔티티 쓰기 지연 SQL 저장소에 등록
* 쓰기 지연 SQL 저장소의 쿼리를 데이터베이스에 전송(등록, 수정, 삭제 쿼리)

영속성 컨텍스트를 플러시하는 방법
* em.flush() - 직접 호출
* 트랜잭션 커밋 - 플러시 자동 호출
* JPQL 쿼리 실행 - 플러시 자동 호출