# Stateful 서버란?
서버가 클라이언트의 이전상태를 보존하는 것
서버와 클라이언트간 세션의 상태(state)에 기반하여 클라이언트에 응답(response)을 보낸다 이를 위해 세션 상태를 포함한 클라이언트와의 세션 정보를 서버에 저장한다
대표적인 Stateful 구조를 따르는 프로토콜로 TCP가 있다

예로 세션을 유지하는 웹 서버가 있다. 유저가 로그인을 하면 세션에 로그인이 되었다고 저장하고, 서비스를 제공할 때 그 데이터를 이용한다.  

# Stateless 서버란?
서버가 클라이언트의 이전상태를 보존하지 않는 것.  
서버의 응답이 클라이언트와의 세션 상태와 독립적이다.

서버는 단순히 요청이 오면 응답을 보내는 역할만 수행하며, 세션 관리는 클라이언트에게 책임이 있다.

대표적인 프로토콜로 UDP와 HTTP 등이 있다

장점
* 스케일 아웃에 유리하다	
    * stateful의 경우 서버가 세션 정보를 유지하기 때문에 만약 서버장애등의 이유로 서버가 바뀐다면 기존 서버에 있던 세션 정보를 새로운 서버로 옮겨주어야 한다
    * stateless의 경우 서버가 세션 정보를 유지하지 않기 때문에 자유롭게 수평확장이 가능하다

한계
* 전송되는 데이터양이 stateful보다 많다
* 로그인등 상태를 유지해줘야 하는 경우가 있다
* 브라우저 쿠키와 서버 세션등을 사용해서 상태 유지한다
    * 상태 유지는 최소한만 사용해야 한다

이렇게 할경우 클라이언트와 서버의 연결고리가 없기 때문에 서버의 확장성(Scalability)가 높아진다.


# 서버 기반 인증
기존의 인증 시스템에서는 서버측에서 유저들의 정보를 기억하고 있어야 했다. 이 세션을 유지하기 위해서는 여러 방법이 사용됬는데, 메모리/디스크/DBS 등이다. 

![](https://velopert.com/wp-content/uploads/2016/12/bb.png)

위 그림처럼 기존의 서버방식에는 유저의 로그인 정보를 유지하며, 요청이 들어왔을 때 이를 확인하고 응답해주는 방식이었다. 

## 서버 기반 인증의 문제점
### 세션
유저가 인증을 할 때, 서버는 이 기록을 서버에 저장을 해야한다. 이를 **세션**이라 부른다. 만약 로그인 중인 유저의 수가 늘어나게되 세션이 늘어난다면 서버의 성능에 무리를 줄 수 있다.

### 확장성
세션을 사용하면 여러 프로세스를 돌리거나, 여러 대의 서버 컴퓨터를 추가하는 등 서버를 확장하는 것이 어려워진다. 

### CORS(Cross-Origin Resource Sharing)
웹 어플리케이션에서 세션을 관리 할 때 자주 사용되는 쿠키는 단일 도메인 및 서브 도메인에서만 작동하도록 설계되어있다. 따라서 쿠키를 여러 도메인에서 관리하는 것은 번거롭다.

# 토큰 기반 시스템의 작동 원리
토큰 기반 시스템은 stateless하다. 더 이상 유저의 인증 정보를 서버나 세션에 담아두지 않는다. 

세션이 존재하지 않으니, 유저들의 로그인 여부와 상관없이 서버를 손쉽게 확장할 수 있다.

![](https://velopert.com/wp-content/uploads/2016/12/token-diagram.png)

토큰 기반 시스템의 구현 방식은 다음과 같다
1. 유저가 아이디와 비밀번호로 로그인 한다.
2. 서버측에서 해당 계정정보를 검증한다
3. 계정정보가 정확하다면, 서버측에서 유저에게 signature를 지닌 토큰을 발급해 준다.
4. 클라이언트 측에서 전달받은 토큰을 저장해두고, 서버에 요청을 할 때마다, 해당 토큰을 함께 서버에 전달한다
5. 서버는 토큰을 검증하고, 요청에 응답한다

웹 서버에서 토큰을 서버에 전달 할 때에는, HTTP 요청의 헤더에 토큰값을 포함시켜 전달한다.

# 토큰의 장점
## 무상태(stateless)이며 확장성(scalability)가 있다.
토큰은 클라이언트사이드에 저장하기 때문에 완정히 stateless하며, 서버를 확장하기에 매우 적합한 환경을 제공한다. 

만약 세션을 사용한다면 서버를 확장했을 때 어떤 유저가 로그인했을 때 그 유저는 처음 로그인했던 그 서버에만 요청을 보내도록 설정해야 한다. 하지만, 토큰을 사용한다면, 어떤 서버로 요청이 들어가던 상관이 없게 된다.

## 보안성
클라이언트가 서버에 요청을 보낼 때, 더 이상 쿠키를 전달하지 않음으로 쿠키를 사용함으로 인해 발생하는 취약점이 사라진다. 

## Extensibility(확장성)
Scalability는 서버를 확장하는 것을 의미하는 반면, Extensibility는 로그인 정보가 사용되는 분야를 확장하는 것을 의미한다. 

토큰을 사용하여 다른 서비스에서도 권한을 공유할 수 있게 된다. Google, 카카오 등의 계정으로 로그인을 할 수 있게 해주는 기능 등이다.

토큰 기반 시스템에서는, 토큰에 선택적인 권한만 부여하여 발급을 할 수 있다. 

## 여러 플랫폼 및 도메인
서버 기반 인증 시스템의 문제점 중 CORS를 해결할 수 있다.

어플리케이션과 서비스의 규모가 커지면, 여러 디바이스를 호환시키고, 더 많은 종류의 서비스를 제공하게 된다. 토큰을 사용한다면, 그 어떤 디바이스에서도, 그 어떤 도메인에서도, 토큰만 유효하다면 요청이 정상적으로 처리된다. 

## 웹 표준 기반
토큰 기반 인증 시스템의 구현체인 JWT는 웹 표준 RFC 7519에 등록이 되어있다. 따라서 여러 환경에서 지원이 되며, 수많은 회사의 인프라스트럭쳐에서 사용 되고 있다.



# Reference
https://velopert.com/2350

