# Lock
DB에 동시에 여러 접근이 들어올 때 일관성과 무결성을 유지하기 위해 사용한다.

트랜잭션 처리의 순차성을 보장해주기 위해 하나의 트랜잭션이 완벽하게 끝날 때까지 다른 요청을 막아주는 역할을 합니다.

DBMS 마다 Lock을 구현하는 방식과 세부적인 방법이 다르답니다. 따라서 DBMS를 효과적으로 이용하기 위해 해당 DB의 Lock에 대한 이해가 필요합니다.

Shared Lock과 Exlusive Lock 이 있습니다. 

## Shared Lock
Read Lock 이라고도 하는 공유락은 데이터를 읽을 때 사용하는 Lock 입니다. 같은 Read Lock끼리는 동시에 접근이 가능합니다. 대신 Exclusive Lock의 접근을 막습니다.

## Exclusive Lock
Write Lock 이라고도 합니다. 데이터를 변경하는 경우 사용됩니다. Lock이 해제될 때까지 다른 트랜잭션은 해당 리소스에(읽기포함) 접근할 수 없습니다. 또한 해당 Lock은 다른 트랜잭션이 수행하고 있는 데이터에 대해서는 접근하여 함께 Lock을 설정힐 수 없습니다.

# Lock의 설정 범위
* 데이터베이스  
    * DB 전체에 Lock을 거는 것입니다. 1개 세션만이 DB의 데이터에 접근할 수 있습니다
    * DB 업데이트 등에 사용합니다
* 테이블
    * 테이블을 기준으로 Lock 을 설정합니다. DDL 등 테이블을 대상으로하는 연산에 사용됩니다
* 행
    * 1개의 행을 기준으로 Lock을 설정합니다. DML에 대한 Lock으로 가장 일반적으로 사용합니다

# 블로킹(Blocking)
Lock 간의 경합이 발생하여 특정 Transcation이 작업을 진행하지 못하고 멈춰선 상태. 

Exclusive Lock의 경우 접근을 막기 때문에 발생하게 됩니다. 뒤에 들어온 트랜잭션은 앞의 트랜잭션의 작업이 마무리되어야 이후 진행이 가능합니다.

성능에 좋지 않기 때문에 최소화 할 필요가 있습니다.

블로킹을 피하는 주의사항
* 한 트랜잭션의 길이를 너무 길게하는 것은 경합의 확률을 높입니다
* 처음부터 설계할 때 같은 데이터를 갱신하는 트랜잭션이 동시에 수행되지 않도록 합니다
* 트랜잭션 격리성 수준을 불필요하게 상향조정하지 않습니다
* 쿼리를 오랜시간 잡아두지 않도록 적절한 튜닝을 진행합니다

# 교착상태(DeadLock)
두 트랜잭션이 각각 Lock을 설정한 다음 서로의 Lock에 접근하여 값을 얻어오려고 시도할 경우 발생하게 됩니다. 각각의 트랜잭션에 의해 Lock이 설정되어 있기 때문에 양쪽 트랜잭션 모두 영원히 처리되지 않습니다.

이 경우 둘 중 한 트랜잭션에 에러를 발생시킴으로써 문제를 해결합니다. 교착 상태가 발생할 가능성을 줄이기 위해 접근 순서를 동일하게 하는 것이 중요합니다. 

Mysql의 경우 default로 데드락 감지로 2개의 트랜잭션 중 데이터 변화가 적은 트랜잭션을 rollback 시켜 데드락을 해소합니다. 

